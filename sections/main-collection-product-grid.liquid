<section class="product-grid-section">
  <div class="container">
    {% assign current_sort = collection.sort_by | default: collection.default_sort_by %}

    <div class="sort-bar">
      {% comment %} <label for="sort-by">Sort</label> {% endcomment %}
      <select id="sort-by" name="sort-by"
        onchange="location.href=this.options[this.selectedIndex].dataset.url">
        {% assign base_url = collection.url %}
        <option data-url="{{ base_url }}?sort_by=featured" {% if current_sort == 'featured' %}selected{% endif %}>Featured</option>
        <option data-url="{{ base_url }}?sort_by=best-selling" {% if current_sort == 'best-selling' %}selected{% endif %}>Best selling</option>
        <option data-url="{{ base_url }}?sort_by=title-ascending" {% if current_sort == 'title-ascending' %}selected{% endif %}>A-Z</option>
        <option data-url="{{ base_url }}?sort_by=title-descending" {% if current_sort == 'title-descending' %}selected{% endif %}>Z-A</option>
        <option data-url="{{ base_url }}?sort_by=price-ascending" {% if current_sort == 'price-ascending' %}selected{% endif %}>Low to High</option>
        <option data-url="{{ base_url }}?sort_by=price-descending" {% if current_sort == 'price-descending' %}selected{% endif %}>High to Low</option>
        <option data-url="{{ base_url }}?sort_by=created-ascending" {% if current_sort == 'created-ascending' %}selected{% endif %}>Old to New</option>
        <option data-url="{{ base_url }}?sort_by=created-descending" {% if current_sort == 'created-descending' %}selected{% endif %}>New to Old</option>
      </select>
    </div>

    {% paginate collection.products by section.settings.products_per_page %}
      <div class="product-grid">
        {% for product in collection.products %}
          <div class="product-card">
            {% if product.tags contains 'discount-30' %}
              <div class="discount-label">30% OFF</div>
            {% endif %}
            <div class="product-image-slider-wrapper">
              <div class="product-image-slider">
                {% assign images = product.images | slice: 0, section.settings.slider_image_limit %}
                {% if images.size > 0 %}
                  {% for image in images %}
                    <div>
                      <a href="{{ product.url }}">
                        <img src="{{ image | image_url: width: 600 }}" alt="{{ product.title | escape }}" loading="lazy">
                      </a>
                    </div>
                  {% endfor %}
                {% else %}
                  {% for i in (1..3) %}
                    <div>
                      <a href="{{ product.url }}">
                        <img src="https://cdn.shopify.com/s/files/1/0554/3661/8966/files/placeholder_{{ i }}.jpg?v=1" alt="Placeholder {{ i }}" loading="lazy">
                      </a>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
            </div>

            <h3 class="product-title">
              <a href="{{ product.url }}">{{ product.title }}</a>
            </h3>

            <div class="price">
              {% if product.compare_at_price_max > product.price %}
                <span class="current">{{ product.price | money }}</span>
                <span class="compare">{{ product.compare_at_price_max | money }}</span>
              {% else %}
                <span class="current">{{ product.price | money }}</span>
              {% endif %}
            </div>

            {% assign extra_images = product.images.size | minus: section.settings.slider_image_limit %}
            {% if extra_images > 0 %}
              <div class="image-count-badge">+{{ extra_images }} more</div>
            {% endif %}

            {% comment %} <p>Debug: Reviews = {{ product.metafields.custom.rating_count }}</p> {% endcomment %}
            {% assign rating = 0 %}
            {% for tag in product.tags %}
              {% if tag contains 'rating-' %}
                {% assign rating = tag | remove: 'rating-' | plus: 0 %}
              {% endif %}
            {% endfor %}

            {% assign reviews = product.metafields.custom.rating_count | default: 0 | plus: 0 %}
            {% assign full_stars = rating | floor %}
            {% assign has_half_star = rating | modulo: 1 | times: 10 | round %}
            {% assign empty_stars = 5 | minus: full_stars | minus: has_half_star %}

            {% if rating > 0 %}
              <div class="rating">
                {% for i in (1..full_stars) %}
                  <i class="fa-solid fa-star"></i>
                {% endfor %}
                {% if has_half_star > 0 %}
                  <i class="fa-solid fa-star-half-stroke"></i>
                {% endif %}
                {% for i in (1..empty_stars) %}
                  â˜†
                {% endfor %}
                {% if reviews > 0 %}
                  <span class="reviews">({{ reviews }} Reviews)</span>
                {% else %}
                  <span class="reviews">No reviews yet</span>
                {% endif %}
              </div>
            {% else %}
              <div class="rating">No rating available</div>
            {% endif %}


            {% comment %} {% if section.settings.show_quick_add and product.available %}
              <form method="post" action="/cart/add" class="quick-add">
                <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                <button type="submit" class="btn">Add to cart</button>
              </form>
            {% endif %} {% endcomment %}

            <button class="quick-buy-btn" onclick="location.href='{{ product.url }}'">Quick Buy</button>
          </div>
        {% endfor %}
      </div>

      <div class="pagination">
        {% if paginate.pages > 1 %}
          <nav>
            {% if paginate.previous %}
              <a href="{{ paginate.previous.url }}">Previous</a>
            {% endif %}
            {% for part in paginate.parts %}
              {% if part.is_link %}
                <a href="{{ part.url }}">{{ part.title }}</a>
              {% else %}
                <span class="current">{{ part.title }}</span>
              {% endif %}
            {% endfor %}
            {% if paginate.next %}
              <a href="{{ paginate.next.url }}">Next</a>
            {% endif %}
          </nav>
        {% endif %}
      </div>
    {% endpaginate %}
  </div>
</section>

<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": "{{ product.title }}",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ rating }}",
    "reviewCount": "{{ reviews }}"
    "reviewCount": "{{ product.metafields.custom.rating_count }}"

  }
}
</script>

{% schema %}
{
  "name": "Product Grid",
  "settings": [
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 4,
      "max": 48,
      "step": 4,
      "default": 8
    },
    {
      "type": "range",
      "id": "slider_image_limit",
      "label": "Images per product (slider)",
      "min": 1,
      "max": 5,
      "step": 1,
      "default": 3
    },
    {
      "type": "checkbox",
      "id": "show_quick_add",
      "label": "Show quick add button",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Product Grid",
      "category": "Collection"
    }
  ]
}
{% endschema %}
